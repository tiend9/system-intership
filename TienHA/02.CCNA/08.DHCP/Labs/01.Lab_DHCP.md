# LAB DHCP

## I. Vai trò

Trước tiên, để có thể thực hành lab DHCP trên mô hình Client - Sever thì thay vì phải dùng nhiều máy tính hoặc thiết bị mạng để cấu hình thì ta có thể tạo ra 2 Host ảo trên cùng 1 máy tính xách tay của mình và thức hiện cấu hình DHCP trên chùng.

Và để có thể tạo máy ảo trước hết ta cần phải cài đặt hệ diều hành Linux (đây là hệ điều hành rất hữu ích vì nó tích hợp sẵn các công nghệ nhúng cho pháp can thiệp vào hệ thống sever hay dữ liệu ).

- **Ubuntu:** DHCP server
- **CentOS:** DHCP client

## II. Cấu hình

### 1. `Bước 1` :Cài đặt DHCP Sever trên Ubuntu

- Cập nhật và cài đặt gói DHCP:

  - `isc` là gói phần mềm máy chủ DHCP của ISC

```bash
sudo apt update
sudo apt install isc-dhcp-server -y
```

- Kiểm tra xem cài được chưa :

```bash
dpkg -l | grep isc-dhcp-server
#hoặc
apt list --installed | grep isc-dhcp-server
```

![DHCP](./Lab_images/DHCP_48.png)

- Kiểm tra interface mạng :

```bash
ip a
```

![DHCP](./Lab_images/DHCP_49.png)

### `Bước 2`: Đặt IP tĩnh cho Ubuntu

Sửa file Netplan:

```bash
sudo nano /etc/netplan/50-cloud-init.yaml
```

Sửa thành:

```bash
network:                      # Mọi cấu hình mạng đều bắt buộc nằm dưới network
  version: 2                   
  ethernets:                  # Nhóm cấu hình cho card mạng Ethernet vật lý → Nếu là WiFi sẽ là wifis
    ens33:                    # Tên interface mạng
      dhcp4: false            # Tắt DHCP cho IPv4
      addresses:
        - 192.168.60.138/24   # Gán IP tĩnh cho interface
      routes:                 # Bảng định tuyến cho interface này → Không báo route → không biết gửi packet đi đâu
        - to: 0.0.0.0/0       # Cho mọi mạng (Dùng khi không có route cụ thể)
          via: 192.168.60.1   # Gateway / Nexthop
      nameservers:            # Cấu hình DNS Resolver
        addresses:            # Danh sách DNS Server
          - 8.8.8.8           # Google DNS
          - 1.1.1.1           # Cloudflare DNS

```

Áp dụng cấu hình ngay:

```nano
sudo netplan apply
```

### `Bước 3` : Cấu hình DHCP Sever trên Ubuntu

Sửa file cấu hình `/etc/dhcp/dhcp.conf`:

```bash
sudo nano /etc/dhcp/dhcpd.conf
```

Thêm cấu hình sau:

```bash
default-lease-time 600;
max-lease-time 7200;
authoritative;

subnet 192.168.60.0 netmask 255.255.255.0 {
  range 192.168.60.50 192.168.60.99;
  option routers 192.168.60.1;
  option subnet-mask 255.255.255.0;
  option domain-name-servers 8.8.8.8, 1.1.1.1;
}
```

Trong đó:

- `default-lease-time 600`: Thiết lập thời gian thuê mặc định (default lease time) cho các địa chỉ IP được cấp phát bởi DHCP server là 600 giây (10 phút).
- `max-lease-time 7200`: Thiết lập thời gian thuê tối đa mà DHCP server sẽ cấp phát cho một client là 7200 giây (2 giờ). Khi client yêu cầu thời gian thuê dài hơn, server sẽ không cấp phát quá thời gian này.
- `authoritative`: Khai báo rằng DHCP server này là có thẩm quyền (authoritative) cho các subnet được cấu hình trong file này. Server sẽ phản hồi các yêu cầu DHCP ngay cả khi nó không chắc chắn về cấu hình mạng.
- `subnet 192.168.186.0 netmask 255.255.255.0 { ... }`:
  - `subnet 192.168.186.0`: Xác định địa chỉ mạng của subnet là `192.168.186.0`.
  - `netmask 255.255.255.0`: Xác định subnet mask cho subnet này là `255.255.255.0`.
  - `range 192.168.186.100 192.168.186.150`: Dải địa chỉ DHCP có thể cấp phát.
  - `option routers 192.168.186.1`: `192.168.186.1` là địa chỉ IP của router (cổng mặc định - default gateway) mà các client sẽ sử dụng để truy cập các mạng khác bên ngoài subnet này.
  - `option domain-name-servers 8.8.8.8, 1.1.1.1`: Thiết lập tùy chọn `domain-name-servers` cho các client trong subnet. Các client sẽ sử dụng các địa chỉ IP `8.8.8.8` (máy chủ DNS của Google) và `1.1.1.1` (máy chủ DNS của Cloudflare) này để phân giải tên miền thành địa chỉ IP.

Chỉ định interface để DHCP lắng nghe, sửa file:

```bash
sudo nano /etc/default/isc-dhcp-server
```

Tìm dòng:

```bash
INTERFACESv4=""
```

Thay bằng:

```bash
INTERFACESv4="ens33"  # Hoặc interface kiểm tra được ở bước trên
```

Khởi động DHCP Server:

```bash
sudo systemctl restart isc-dhcp-server
sudo systemctl status isc-dhcp-server
```

Kết quả DHCP đang chạy:

![DHCP](./Lab_images/DHCP_50.png)

### `Bước 3`: Cấu hình DHCP Client trên CentOS9 để nó dùng được DHCP

- Kiểm tra Interface của mạng:

-> Ở đây ta dùng mạng `ens160`

```bash
ip a
```

![DHCP](./Lab_images/DHCP_51.png)

- Vào file cấu hình `/etc/NetworkManager/system-connections/ens160.nmconnection` của giao diện mạng `ens160`

  - Sửa file thành :

  ```bash
  nano /etc/NetworkManager/system-connections/ens160.nmconnection
  ```

![DHCP](./Lab_images/DHCP_52.png)

- Khởi động lại NetworkManager để áp dụng:

```bash
sudo systemctl restart NetworkManager
```

- Kiểm tra IP:

```bash
ip a
```

- Kết quả hiển thị:

