# CONFIG WORDPRESS PAGE WITH DOMAIN NAME `cloud.test`

## I. MỤC TIÊU

- Triển khai DNS Server nội bộ sử dụng BIND9  
- Cấu hình domain name cloud.test cho website WordPress  
- Thực hiện phân giải thuận (A record) cho website  
- Thực hiện phân giải ngược (PTR record) cho máy chủ Web  
- Kiểm tra và xác nhận DNS hoạt động đúng với WordPress

## II. MÔ HÌNH BÀI LAB

![DNS](./Lab_images/DNS_37.png)

## III. THÔNG TIN MÔ HÌNH

### 1. Domain sử dụng

- Domain website: `cloud.test`
- FQDN website WordPress: `www.cloud.test`

  - `.test` là domain được RFC quy định dành riêng cho testing, an toàn và không gây xung đột mDNS

### 2. IP và vai trò các máy

| Máy        | Hostname            | IP              | Vai trò          |
| ---------- | ------------------- | --------------- | ---------------- |
| DNS Server | `dns.cloud.test`    | `192.168.70.74` | BIND9 DNS Server |
| Web Server | `wp.cloud.test`     | `192.168.70.80` | WordPress        |
| Client     | `client.cloud.test` | `192.168.70.72` | Truy vấn DNS     |

## IV. THÀNH PHẦN CHÍNH CỦA HỆ THỐNG

| Thành phần           | Vai trò               |
| -------------------- | --------------------- |
| BIND9 (`named`)      | Phần mềm DNS server   |
| `named.conf.options` | Cấu hình toàn cục DNS |
| `named.conf.local`   | Khai báo zone         |
| Forward Zone         | Phân giải tên → IP    |
| Reverse Zone         | Phân giải IP → tên    |

## V. TRIỂN KHAI

### Bước 1: Cài đặt trên DNSServer(BIND9)

Thực hiện trên DNS Server – 192.168.70.74

```bash
sudo apt update
sudo apt install bind9 bind9utils bind9-dnsutils -y
```

Kiểm tra dịch vụ:

```bash
systemctl status bind9
```

![DNS](./Lab_images/DNS_38.png)

### Bước2: Cấu hình DNS toàn cục

Mở file cấu hình:`/etc/bind/named.conf.options`

```bash
nano /etc/bind/named.conf.options
```

Chèn nội dung:

```bash
options {
    directory "/var/cache/bind";

    recursion yes;
    allow-query { any; };
    listen-on { 127.0.0.1; 192.168.70.74; };

    forwarders {
        8.8.8.8;
        1.1.1.1;
    };

    dnssec-validation no;
};
```

### Bước 3: Khai báo Zone DNS

Mở file cấu hình :`/etc/bind/named.conf.local`

```bash
nano /etc/bind/named.conf.local
```

Thêm nội dung:

```bash
zone "cloud.test" {
    type master;
    file "/etc/bind/zones/db.cloud.test";
};

zone "70.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.70";
};
```

### Bước 4: Tạo Forward Zone(A Record)

Tạo thư mục Zone:

```bash
sudo mkdir /etc/bind/zones
```

Phân quyền và bảo mật file:

```bash
sudo chown -R root:bind /etc/bind/zones
sudo chmod -R 755 /etc/bind/zones
```

Chỉnh sửa cấu hình file `/etc/bind/zones/db.cloud.test`

```bash
nano /etc/bind/zones/db.cloud.test
```

Chèn nội dung sau:

```bash
$TTL 86400
@ IN SOA dns.cloud.test. admin.cloud.test. (
2026012701
3600
1800
604800
86400
)


@ IN NS dns.cloud.test.                       # Máy chịu trách nghiệm phân giải DNS cho Domain này
@ IN  A   192.168.70.80                       # Bản ghi A Record cho Domain gốc cloud.test
dns IN A 192.168.70.74                        # Máy dns.cloud.test có địa chỉ IP là 192.168.70.74”
wp IN A 192.168.70.80                         # Máy chủ WordPress có tên wp.cloud.test và IP là 192.168.70.80
www IN A 192.168.70.80                        # Người dùng truy cập www.cloud.test sẽ vào Web Server WordPress
```

### Bước 5: Tạo Reverse Zone (PTR Record)

Chỉnh sửa cấu hình file `/etc/bind/zones/db.192.168.70`

```bash
sudo nano /etc/bind/zones/db.192.168.70
```

Chèn nội dung sau:

```bash
$TTL 86400
@   IN  SOA dns.cloud.test. admin.cloud.test. (
        2026012701
        3600
        1800
        604800
        86400
)

@       IN  NS      dns.cloud.test.
74      IN  PTR     dns.cloud.test.
80      IN  PTR     wp.cloud.test.
```

### Bước 6: Kiểm tra cấu hình DNS

```bash
sudo named-checkconf
sudo named-checkzone cloud.test /etc/bind/zones/db.cloud.test
sudo named-checkzone 70.168.192.in-addr.arpa /etc/bind/zones/db.192.168.70
```

Restart DNS:

```bash
sudo systemctl restart bind9
```

![DNS](./Lab_images/DNS_39.png)

### Bước 7: Cấu hình DNS cho Client

MỞ file `/etc/resolv.conf`

```bash
nano /etc/resolv.conf
```

Chỉnh:

```bash
nameserver 192.168.70.74
```

Áp dụng:

```bash
sudo netplan apply
```

### Bước 8: Kiểm tra phân giải DNS

#### Forward Lookup

```bash
dig www.cloud.test
nslookup www.cloud.test
```

Kết quả nhận được:

![DNS](./Lab_images/DNS_40.png)

#### Reverse Lookup

```bash
dig -x 192.168.70.80
```

Kết quả nhận được:

![DNS](./Lab_images/DNS_41.png)

### Bước 9: Cấu hình nhanh WordPress

Các bước tạo trang WordPress đã có hướng dẫn chi tiết hãy làm theo các bước sau [đây](https://github.com/tiend9/system-intership/blob/master/TienHA/08.WordPress/Labs/01.Build_Website_LAMP.md)

`Lưu ý`: Khai báo Server Name cho Apache

```bash
sudo nano /etc/apache2/apache2.conf

# Thêm dòng cuối file

ServerName wp.cloud.test
```

Tạo file VirtualHost như sau:

```bash
nano /etc/apache2/sites-enabled/wordpress.conf
# Thêm cấu hình
<VirtualHost *:80>
    ServerName wp.cloud.test
    ServerAlias www.cloud.test
    DocumentRoot /var/www/html/wordpress

    <Directory /var/www/html/wordpress>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/wordpress_error.log
    CustomLog ${APACHE_LOG_DIR}/wordpress_access.log combined
</VirtualHost>
```

Restart Apache:

```bash
sudo systemctl restart apache2
```

Tạo user Mysql vá Database `Cloud.test`để import vào file `config.php`

```sql
CREATE DATABASE Cloud_test;
CREATE USER 'tien9a'@'localhost' IDENTIFIED BY 'Tien9a@123';
GRANT ALL PRIVILEGES ON Cloud_test.* TO 'tien9a'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

Mở port lắng nghe các địa chỉ ngoài của MySQL nếu muốn máy ngoài truy cập vào:

```bash
nano /etc/mysql/mysql.conf.d/mysqld.cnf

# Sửa chỗ bind address
127.0.0.1 -> 0.0.0.0
```

![DNS](./Lab_images/DNS_43.png)

Tiếp theo import DataBases vào file `wp-config.php`

![DNS](./Lab_images/DNS_44.png)

Xong Restart lại Apache:

```bash
sudo systemctl restart apache2
```

### Bước 10: Kiểm tra trang WordPress

#### TRuy cập trang WordPress bằng IP

Sau đó ta sẽ được trang WordPress truy cập bằng IP như sau đây:(Có thể truy cập bằng máy đang lab vì đã chỉnh port)

```text
http://192.168.70.80
```

Hoàn thành nốt các bước nhập thông tin rồi `Install Wordpress`

![DNS](./Lab_images/DNS_45.png)

Sau khi truy cập thì trang WordPress yêu cầu cấu hình để tạo DB dự phòng:

![DNS](./Lab_images/DNS_46.png)

Ta vào lại file config `wp-config.php` thêm dòng `define('WP_ALLOW_REPAIR', true);`

![DNS](./Lab_images/DNS_47.png)

Restart lại Apache và Page. Giao diện trang lúc này sẽ hiện

![DNS](./Lab_images/DNS_48.png)

![DNS](./Lab_images/DNS_49.png)

Rồi sau đó xoá dòng ``define('WP_ALLOW_REPAIR', true);`` trong file ``wp-config.php``rồi restart Apache và reload lại trang login:

![DNS](./Lab_images/DNS_50.png)

Sau khi vào giao diện WordPRess, ta thử tạo trang blog như sau:

![DNS](./Lab_images/DNS_51.png)

![DNS](./Lab_images/DNS_52.png)

#### Truy cập trang WordPress bằng tên miền `Cloud.test`

Truy cập trình duyệt trang WordPress `Cloud.test` từ máy tinh đang lab:

```text
http://www.cloud.test
```

Kết quả hiển thị:

![DNS](./Lab_images/DNS_53.png)

=> Ở đây, ta mắc một lỗi rất cơ bản khi lab DNS đó là `DNS_PROBE_FINISHED_NXDOMAIN` (hay **NXDOMAIN**)

- **NXDOMAIN**(Non-Existent Domain): Domain không tồn tại trong DNS, hay hiểu là khi ta Query DNSServer không tìm thấy bản ghi cho tên miền đó

Ví dụ:

```bash
dig cloud.test
```

Trả về:

```bash
status: NXDOMAIN
```

→ DNS bảo: “tao không biết thằng `cloud.test` là ai cả”.

Nguyên nhân xảy ra lỗi **NXDOMAIN**:

- **DNSServer chưa hoạt động**

- **Chưa khai báo zone**:

  - Chưa có file zone `cloud.test`
  - Chưa có zone `"cloud.test" { ... }` trong `named.conf`

  -> DNS không biết domain này tồn tại

- **Zone có nhưng không có bản ghi**

  - Ví dụ zone có rồi nhưng không có A record:

  ```bash
  cloud.test.   IN   A   192.168.1.10
  ```

  → `dig cloud.test` = `NXDOMAIN`

- **SOA / NS sai**

- **Client hỏi nhầm DNS**

- **Forwarder ăn gian**

### Bước 11: Cách Check Lỗi `NXDOMAIN`

#### 1. Check DNS Server có đang hoạt động không

Trên con này DNSServer `192.168.70.74`. Trước tiên, phải đảm bảo dịch vụ DNS (BIND9) đang chạy.

```bash
systemctl status named
```

- `active (running)` → OK
- `inactive / failed` → DNS Server không hoạt động

![DNS](./Lab_images/DNS_54.png)

=> Trạng thái `active`-> OK

Nếu DNS chưa chạy:

```bash
systemctl start named
systemctl enable named
```

#### 2. Check cấu hình tổng thể BIND

Kiểm tra lỗi cú pháp trong các file cấu hình DNS.

```bash
        named-checkconf
```

- Không có output → cấu hình hợp lệ
- Có lỗi → sửa theo dòng báo lỗi

![DNS](./Lab_images/DNS_55.png)

=> Không có Output -> OK

#### 3. Check đã khai báo zone `cloud.test` hay chưa

Mở file cấu hình zone (ví dụ: /etc/named.conf hoặc /etc/bind/named.conf.local):

```bash
cat /etc/named.conf
```

Hoặc:

```bash
cat /etc/bind/named.conf.local
```

Phải có khai báo zone dạng:

```bash
zone "cloud.test" {
    type master;
    file "/var/named/cloud.test.zone";
};
```

- Nếu chưa có → DNS không biết domain tồn tại → `NXDOMAIN`

![DNS](./Lab_images/DNS_56.png)

=> Đã khai báo 2 Zone thuận và ngược

#### 4. Check file zone có tồn tại không

Kiểm tra file zone đã khai báo:

```bash
ls -l /var/named/cloud.test.zone
```

hoặc:

```bash
 ls -l /etc/bind/zones
```

- Không tồn tại → tạo file zone
- Có nhưng sai quyền → DNS không đọc được

Fix quyền:

```bash
chown root:named /var/named/cloud.test.zone
chmod 640 /var/named/cloud.test.zone
```

![DNS](./Lab_images/DNS_57.png)

=> Đã tồn tại zone và cũng đã được cấp quyền

#### 5. Check nội dung file zone (SOA / NS / A record)

Kiểm tra cấu trúc zone:

```bash
sudo named-checkconf
sudo named-checkzone cloud.test /etc/bind/zones/db.cloud.test
sudo named-checkzone 70.168.192.in-addr.arpa /etc/bind/zones/db.192.168.70
```

- `OK` → zone hợp lệ
- `FAILED` → lỗi SOA, NS, syntax

Ví dụ zone tối thiểu đúng:

```bash
$TTL 86400
@   IN  SOA ns1.cloud.test. admin.cloud.test. (
        2026012801
        3600
        1800
        604800
        86400
)


@       IN  NS      ns1.cloud.test.
ns1     IN  A       192.168.1.2
@       IN  A       192.168.1.10
www     IN  A       192.168.1.10
```

- Thiếu A `record` cho domain → `NXDOMAIN`

![DNS](./Lab_images/DNS_58.png)

=> Có `OK`-> đúng rồi

#### 6. Check 3 con có hỏi đúng DNS Server không

Tra:

```bash
cat /etc/resolv.conf
```

Hoặc (Ubuntu mới):

```bash
resolvectl status
```

Phải thấy:

```bash
nameserver <IP_DNS_SERVER>
```

- Nếu đang trỏ 8.8.8.8 hoặc DNS khác → DNS nội bộ không được hỏi

![DNS](./Lab_images/DNS_59.png)
![DNS](./Lab_images/DNS_62.png)
![DNS](./Lab_images/DNS_63.png)

=> Đã bắt được lỗi sai **NXDOMAIN** ở dây đó là: Ở giao diện `Global` thì Client vẫn nhận diện được DNS nhưng ở card mạng `ens3` 3 con đang Query Google DNS thay vì DNS nội bộ.

#### 7. Check bằng dig chỉ định DNS Server

Query trực tiếp vào DNS Server để loại trừ lỗi Client:

```bash
dig @192.168.70.74 cloud.test +noall +answer
dig @192.168.70.74 www.cloud.test +noall +answer
```

- Có IP → DNS OK
- `NXDOMAIN` → lỗi nằm ở DNS Server

![DNS](./Lab_images/DNS_60.png)

=> Hiện IP -> `OK`

#### 8 Check forwarder (tránh bị “ăn gian”)

Mở file cấu hình DNS:

```bash
cat /etc/bind/named.conf.options
```

Nếu thấy:

```bash
forwarders {
    8.8.8.8;
    1.1.1.1;
};
```

→ Google DNS không biết domain nội bộ
→ trả về NXDOMAIN

Giải pháp:

- Xoá forwarder
- Hoặc cấu hình forward only / forward first phù hợp

![DNS](./Lab_images/DNS_61.png)

=>`OK` -> Không xảy ra vấn đề gì

### Bước 12: Debug lỗi `NXDOMAIN`

#### Hiểu rõ bản chất

Do **Systemd-resolved** ưu tiên DNS theo interface:

Thứ tự ưu tiên:

- DNS gắn với interface (ens3) ← đang là `8.8.8.8`
- DNS Global

Nên:

- `dig cloud.test` → hỏi `8.8.8.8`
- `cloud.test` là domain nội bộ → NXDOMAIN

### Bước 12: Tìm cách DEBUG tối ưu

#### Cách 1: FIX mỗi con client

Cả 3 con `Client`, `Server` và `Web` khi tra check `resolvectl status` thì giao diện `ens3` đều đang Query Google DNS và mục tiêu của ta là truy cập được `www.cloud.test`.

=> Chỉ cần sửa DNS trên con Client(client.cloud.test)

Bởi vì :

- Client là máy Query DNS
- DNS Server không Query chính nó
- Web Server không cần phân giải domain của chính nó để serve HTTP

Và nó chỉ lỗi nếu:

- DNS server cần resolve domain ngoài (update, apt, forward)
- WordPress gọi API ngoài hay update theme; plugin

#### Cách 2: Fix trên cả 3 con VM 

Để giúp mô hình lab chuẩn Enterprise, không phụ thuộc Internet và Log debut không bị loạn thì ta lên sửa file `nmcli`,`netplan` or `resolved file` tuỳ theo máy đang ưu tiên cái nào hơn

=> **MỌI MÁY TRONG LAB → DNS trỏ về DNS Server nội bộ**

### Bước 13: Tiến hành DEBUG

Ta chọn cách 2 để FIX vì cần ưu tiên độ chuẩn xác của mô hình

#### 1. Check xem VM đang ưu tiên cấu hình mạng bằng file nào `nmcli`,`netplan` hay `resolved.conf`

Check connection của `nmcli`:

```bash
nmcli con show
```

=> Cả 3 máy không thấy connect nào chứng tỏ không dùng `nmcli`

Chỉnh file `resolved.conf`:

```bash
sudo nano /etc/systemd/resolved.conf
```

Add cấu hình:

```bash
[Resolve]
DNS=192.168.70.74
Domains=cloud.test
```

Kiểm tra:

```bash
resolvectl status
```

=> Cả 3 máy vẫn Query Google DNS -> VM ưu tiên cấu hình ở netplan hơn

Chỉnh file `netplan`. Trước hết check :

```bash
ls /etc/netplan
```

-> Trên con Client đã fix rồi

-> Trên con DNSServer:
![DNS](./Lab_images/DNS_64.png)

-> Trên con WebServer:
![DNS](./Lab_images/DNS_65.png)
