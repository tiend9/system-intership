# CHUYỂN WEBSITE APACHE TỪ HTTP SANG HTTPS BẰNG OPEN SSL

Trước đó ta đang có 2 websever `mywebsite1.com` và `mywebsite2.com` chạy trên cổng dịch vụ `80` và cùng 1 địa chỉ IP.

## CÁCH 1: MỖI SITE SẼ DÙNG `.CRT` KHÁC NHAU

### 1. BƯỚC 1: Active Module SSL and Install OpenSSL

```bash
sudo a2enmod ssl
sudo systemctl restart apache2
```

### 2. BƯỚC 2: Tạo thư mục chứa CRT cho từng site

**Website 1**:

```bash
sudo mkdir -p /etc/ssl/mywebsite1
```

**Website 2**:

```bash
sudo mkdir -p /etc/ssl/mywebsite2
```

### 3. BƯỚC 3: Tạo Self-Signed CA

#### a. Tạo private key cho CA

```bash
sudo mkdir -p /etc/ssl/myCA
sudo openssl genrsa -out /etc/ssl/myCA/myCA.key 4096
```

#### b. TẠO SELF-SIGNED CER CHO CA

```bash
sudo openssl req -x509 -new -nodes -key /etc/ssl/myCA/myCA.key \
 -sha256 -days 3650 -out /etc/ssl/myCA/myCA.crt \
 -subj "/C=VN/ST=HN/L=Hanoi/O=TIEND9/OU=DevOps/CN=TIEND9"
```

`myCA.crt` → public certificate, dùng để import vào client

`myCA.key` → private key, giữ trên server

### 4. Bước 4: Tạo Private Key + CSR cho từng website

**Website 1**:

```bash
sudo openssl genrsa -out /etc/ssl/mywebsite1/mywebsite1.key 2048
sudo openssl req -new -key /etc/ssl/mywebsite1/mywebsite1.key \
 -out /etc/ssl/mywebsite1/mywebsite1.csr \
 -subj "/C=VN/ST=HN/L=Hanoi/O=TIEND9/OU=DevOps/CN=mywebsite1.com"
```

**Website 2**:

```bash
sudo openssl genrsa -out /etc/ssl/mywebsite2/mywebsite2.key 2048
sudo openssl req -new -key /etc/ssl/mywebsite2/mywebsite2.key \
 -out /etc/ssl/mywebsite2/mywebsite2.csr \
 -subj "/C=VN/ST=HN/L=Hanoi/O=TIEND9/OU=DevOps/CN=mywebsite2.com"
```

### 5. Bước 5: CA ký Certificate (CRT) cho từng website

**Website 1**:

```bash
sudo openssl x509 -req -in /etc/ssl/mywebsite1/mywebsite1.csr \
 -CA /etc/ssl/myCA/myCA.crt -CAkey /etc/ssl/myCA/myCA.key \
 -CAcreateserial -out /etc/ssl/mywebsite1/mywebsite1.crt \
 -days 365 -sha256
```

**Website 2**:

```bash
sudo openssl x509 -req -in /etc/ssl/mywebsite2/mywebsite2.csr \
 -CA /etc/ssl/myCA/myCA.crt -CAkey /etc/ssl/myCA/myCA.key \
 -CAcreateserial -out /etc/ssl/mywebsite2/mywebsite2.crt \
 -days 365 -sha256
```

Kết quả mỗi website sẽ có:

- `key` → private key
- `crt` → cert được CA ký

### 6. BƯỚC 6: Tạo 2 VirtualHosts HTTPS (port 443)

**Website 1**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite1-ssl.conf
```

`/etc/apache2/sites-available/mywebsite1-ssl.conf`

```bash
<VirtualHost *:443>
    ServerName mywebsite1.com
    ServerAlias www.mywebsite1.com
    DocumentRoot /var/www/mywebsite1.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/mywebsite1/mywebsite1.crt
    SSLCertificateKeyFile /etc/ssl/mywebsite1/mywebsite1.key

    <Directory /var/www/mywebsite1.com>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/mywebsite1-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/mywebsite1-ssl-access.log combined
</VirtualHost>

```

**Website 2**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite2-ssl.conf
```

`/etc/apache2/sites-available/mywebsite2-ssl.conf`

```bash
<VirtualHost *:443>
    ServerName mywebsite2.com
    ServerAlias www.mywebsite2.com
    DocumentRoot /var/www/mywebsite2.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/mywebsite2/mywebsite2.crt
    SSLCertificateKeyFile /etc/ssl/mywebsite2/mywebsite2.key

    <Directory /var/www/mywebsite2.com>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/mywebsite2-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/mywebsite2-ssl-access.log combined
</VirtualHost>

```

### 7. BƯỚC 7: Import CERTIFICATE vào TRUSTROOT CA để tránh cảnh báo

**Ubuntu client**:

```bash
sudo cp /etc/ssl/myCA/myCA.crt /usr/local/share/ca-certificates/myCA.crt
sudo update-ca-certificates
```

**Lưu ý**: Không copy file .key sang client. Và chỉ làm cách này khi ta đang tạo cert trực tiếp cho từng website, nhưng không có CA, nên client sẽ luôn báo `ERR_CERT_AUTHORITY_INVALID` => Nếu mục đích internal / test thì để browser tin tưởng, cần tạo một self-signed CA, sau đó ký certificate cho từng site.

Nếu dùng nhiều website, nên tạo 1 self-signed CA → ký certificate cho tất cả website → chỉ cần import 1 CA vào client (Không copy file `.key` sang client)

### 8. BƯỚC 8: Bật cả 2 Site HTTPS

```bash
sudo a2ensite mywebsite1-ssl.conf
sudo a2ensite mywebsite2-ssl.conf
```

### 9. BƯỚC 9: Reditect HTTP → HTTPS nếu chưa bật

**Sửa VirtualHost HTTP (port 80)**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite1.conf
```

**Sửa**:

```bash
<VirtualHost *:80>
    ServerName mywebsite1.com
    ServerAlias www.mywebsite1.com
    Redirect permanent / https://mywebsite1.com/
</VirtualHost>
```

=> Làm tương tự với website 2

**Reload**:

```bash
sudo systemctl reload apache2
```

**Kiểm tra lại**:

```bash
sudo apache2ctl configtest
```

### 10. BƯỚC 10: Cho pháp cổng HTTPS (443) trên FIREWALL

```bash
sudo ufw enable
sudo ufw allow 443
sudo systemctl restart apache2
```

### 11. BƯỚC 11: Truy cập WEBSITE

```ruby
https://mywebsite1.com
https://mywebsite2.com
```

### 12. LƯU Ý

**Quan trọng**: Apache sẽ phân biệt 2 domain HTTPS nhờ **SNI**. **SNI** cho phép nhiều chứng chỉ SSL trên cùng 1 IP.

- Không cần nhiều IP.
- Không cần nhiều server.
- Không cần nhiều cổng.

=> **Kết quả**: Tất cả đều chạy bình thường.

| Domain         | HTTP (80)        | HTTPS (443) | IP   |
| -------------- | ---------------- | ----------- | ---- |
| mywebsite1.com | Redirect → HTTPS | Chạy SSL    | 1 IP |
| mywebsite2.com | Redirect → HTTPS | Chạy SSL    | 1 IP |

### 13. KẾT QUẢ

![HTTP - HTTPs](./images/http_https_46.png)

Trang web vẫn hiện `Not Secure` do ở phía backend (cụ thể WordPress) site URL vẫn để là http thay vì của https

![HTTP - HTTPs](./images/http_https_47.png)

## CÁCH 2: NHIỀU SITE SẼ DÙNG CHUNG 1 FILE `.CRT` (SAN certificate)

### 1. BƯỚC 1: Tạo private key chung cho cả 2 site

```bash
sudo mkdir -p /etc/ssl/multisite
sudo openssl genrsa -out /etc/ssl/multisite/multisite.key 2048
```

### 2. BƯỚC 2: Tạo file cấu hình SAN (rất quan trọng)

**Tạo file**:

```bash
sudo nano /etc/ssl/multisite/san.cnf
```

**Dán vào**:

```bash
[ req ]
default_bits       = 2048
prompt             = no
default_md         = sha256
req_extensions     = req_ext
distinguished_name = dn

[ dn ]
C  = VN
ST = HN
L  = Hanoi
O  = TIEND9
OU = DevOps
CN = mywebsite1.com

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = mywebsite1.com
DNS.2 = www.mywebsite1.com
DNS.3 = mywebsite2.com
DNS.4 = www.mywebsite2.com
```

=> File này tạo 1 cert chung chứa cả 2 domain.

### 3. BƯỚC 3: Tạo CSR từ key + SAN config

```bash
sudo openssl req -new -key /etc/ssl/multisite/multisite.key \
 -out /etc/ssl/multisite/multisite.csr \
 -config /etc/ssl/multisite/san.cnf
```

### 4. BƯỚC 4: CA ký MULTI-DOMAIN CERT

Giả sử mày đã có CA rồi (`myCA.key` + `myCA.crt`)

```bash
sudo openssl x509 -req \
 -in /etc/ssl/multisite/multisite.csr \
 -CA /etc/ssl/myCA/myCA.crt \
 -CAkey /etc/ssl/myCA/myCA.key \
 -CAcreateserial \
 -out /etc/ssl/multisite/multisite.crt \
 -days 365 \
 -sha256 \
 -extfile /etc/ssl/multisite/san.cnf \
 -extensions req_ext
```

**Kết quả**:

- `multisite.key` (key dùng chung)
- `multisite.crt` (cert chứa cả 2 domain)

=>Bây giờ mày có 1 cert dùng cho 2 site.

### 5. BƯỚC 5: Apache cho cả 2 website dùng chung 1 cert

**Website 1**: (port 443)

```bash
<VirtualHost *:443>
    ServerName mywebsite1.com
    DocumentRoot /var/www/mywebsite1.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/multisite/multisite.crt
    SSLCertificateKeyFile /etc/ssl/multisite/multisite.key
</VirtualHost>
```

**Website 2**: (port 443)

```bash
<VirtualHost *:443>
    ServerName mywebsite2.com
    DocumentRoot /var/www/mywebsite2.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/multisite/multisite.crt
    SSLCertificateKeyFile /etc/ssl/multisite/multisite.key
</VirtualHost>
```

=> Cả 2 website dùng chung cert & key

**Quan trọng**:

- Browser sẽ không lỗi nếu:

  - cert chứa SAN của 2 domain
  - client đã importa myCA.crt (CA duy nhất)