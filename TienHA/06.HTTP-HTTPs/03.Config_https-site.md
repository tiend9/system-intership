# CHUYỂN WEBSITE APACHE TỪ HTTP SANG HTTPS BẰNG OPEN SSL

Trước đó ta đang có 2 websever `mywebsite1.com` và `mywebsite2.com` chạy trên cổng dịch vụ `80` và cùng 1 địa chỉ IP.

## I. BƯỚC 1: ACTIVE MODULE SSL OF APACHE VÀ CÀI OPEN SSL

```bash
sudo a2enmod ssl
sudo systemctl restart apache2
```

## II. BƯỚC 2: TẠO THƯ MỤC CHỨA CHỨNG CHỈ SSL cho từng site

**Website 1**:

```bash
sudo mkdir -p /etc/ssl/mywebsite1
```

**Website 2**:

```bash
sudo mkdir -p /etc/ssl/mywebsite2
```

## III. BƯỚC 3: Tạo Self-Signed CA

### 1. Tạo private key cho CA

```bash
sudo mkdir -p /etc/ssl/myCA
sudo openssl genrsa -out /etc/ssl/myCA/myCA.key 4096
```

### 2. TẠO SELF-SIGNED CER CHO CA

```bash
sudo openssl req -x509 -new -nodes -key /etc/ssl/myCA/myCA.key \
 -sha256 -days 3650 -out /etc/ssl/myCA/myCA.crt \
 -subj "/C=VN/ST=HN/L=Hanoi/O=TIEND9/OU=DevOps/CN=TIEND9"
```

`myCA.crt` → public certificate, dùng để import vào client

`myCA.key` → private key, giữ trên server

## IV. BƯỚC 4: TẠO 2 VirtualHost HTTPS (port 443)

**Website 1**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite1-ssl.conf
```

`/etc/apache2/sites-available/mywebsite1-ssl.conf`

```bash
<VirtualHost *:443>
    ServerName mywebsite1.com
    ServerAlias www.mywebsite1.com
    DocumentRoot /var/www/mywebsite1.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/mywebsite1/mywebsite1.crt
    SSLCertificateKeyFile /etc/ssl/mywebsite1/mywebsite1.key

    <Directory /var/www/mywebsite1.com>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/mywebsite1-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/mywebsite1-ssl-access.log combined
</VirtualHost>

```

**Website 2**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite2-ssl.conf
```

`/etc/apache2/sites-available/mywebsite2-ssl.conf`

```bash
<VirtualHost *:443>
    ServerName mywebsite2.com
    ServerAlias www.mywebsite2.com
    DocumentRoot /var/www/mywebsite2.com

    SSLEngine on
    SSLCertificateFile /etc/ssl/mywebsite2/mywebsite2.crt
    SSLCertificateKeyFile /etc/ssl/mywebsite2/mywebsite2.key

    <Directory /var/www/mywebsite2.com>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/mywebsite2-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/mywebsite2-ssl-access.log combined
</VirtualHost>

```

## V. BƯỚC 5: IMPORT CERTIFICATE VÀO TRUSTROOT CA ĐỂ TRÁNH CẢNH BÁO

**Ubuntu client**:

```bash
sudo cp /etc/ssl/myCA/myCA.crt /usr/local/share/ca-certificates/myCA.crt
sudo update-ca-certificates
```

**Lưu ý**: Không copy file .key sang client. Và chỉ làm cách này khi ta đang tạo cert trực tiếp cho từng website, nhưng không có CA, nên client sẽ luôn báo `ERR_CERT_AUTHORITY_INVALID` => Nếu mục đích internal / test thì để browser tin tưởng, cần tạo một self-signed CA, sau đó ký certificate cho từng site.

Nếu dùng nhiều website, nên tạo 1 self-signed CA → ký certificate cho tất cả website → chỉ cần import 1 CA vào client (Không copy file `.key` sang client)

## VI. BƯỚC 6: BẬT CẢ 2 SITE HTTPS

```bash
sudo a2ensite mywebsite1-ssl.conf
sudo a2ensite mywebsite2-ssl.conf
```

## VII. BƯỚC 7: REDIRECT HTTP → HTTPS NẾU CHƯA BẬT

**Sửa VirtualHost HTTP (port 80)**:

```bash
sudo nano /etc/apache2/sites-available/mywebsite1.conf
```

**Sửa**:

```bash
<VirtualHost *:80>
    ServerName mywebsite1.com
    ServerAlias www.mywebsite1.com
    Redirect permanent / https://mywebsite1.com/
</VirtualHost>
```

=> Làm tương tự với website 2

**Reload**:

```bash
sudo systemctl reload apache2
```

**Kiểm tra lại**:

```bash
sudo apache2ctl configtest
```

## VIII. BƯỚC 8: CHO PHÉP CỔNG HTTPS (443) TRÊN FIREWALL

```bash
sudo ufw enable
sudo ufw allow 443
sudo systemctl restart apache2
```

## IX. BƯỚC 9: TRUY CẬP WEBSITE

```ruby
https://mywebsite1.com
https://mywebsite2.com
```

##  X. LƯU Ý

**Quan trọng**: Apache sẽ phân biệt 2 domain HTTPS nhờ **SNI**. **SNI** cho phép nhiều chứng chỉ SSL trên cùng 1 IP.

- Không cần nhiều IP.
- Không cần nhiều server.
- Không cần nhiều cổng.

=> **Kết quả**: Tất cả đều chạy bình thường.

| Domain         | HTTP (80)        | HTTPS (443) | IP   |
| -------------- | ---------------- | ----------- | ---- |
| mywebsite1.com | Redirect → HTTPS | Chạy SSL    | 1 IP |
| mywebsite2.com | Redirect → HTTPS | Chạy SSL    | 1 IP |

## XI. KẾT QUẢ

![HTTP - HTTPs](./images/http_https_46.png)

Trang web vẫn hiện `Not Secure` do ở phía backend (cụ thể WordPress) site URL vẫn để là http thay vì của https

![HTTP - HTTPs](./images/http_https_47.png)
