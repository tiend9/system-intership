# TÌM HIỂU FILE LOG APACHE

## I. APACHE LOG LÀ GÌ ?

**Nhật ký Apache** (Log apache) ghi lại các sự kiện được xử lý bởi máy chủ web Apache, bao gồm các yêu cầu từ các máy tính khác, phản hồi do Apache gửi và các hành động nội bộ của máy chủ Apache.

Quản trị viên máy chủ, nhà phát triển và nhà phân tích sử dụng các nhật ký này để chẩn đoán sự cố, giám sát bảo mật và phân tích các mẫu lưu lượng truy cập trên máy chủ web. Dưới đây là tổng quan chi tiết về từng loại nhật ký.

Nhật ký Apache được chia thành hai loại chính:

- **Nhật ký truy cập** - Access Log
- **Nhật ký lỗi** - Error log

## II. CÁC LOẠI APACHE LOG

### 1. ACCESS LOG

**Nhật ký truy cập**: (Access log)cung cấp thông tin chi tiết về người gửi yêu cầu đến máy chủ và dữ liệu họ yêu cầu. Mỗi nhật ký yêu cầu chứa các thông tin chi tiết, chẳng hạn như địa chỉ IP của máy khách , dấu thời gian, URL được yêu cầu , mã phản hồi HTTP và kích thước nội dung phản hồi.

**Công dụng chính**:

- Phân tích lưu lượng truy cập trang web.
- Phát hiện các mối đe dọa bảo mật tiềm ẩn và tối ưu hóa hiệu suất máy chủ web.
- Đưa ra các quyết định quan trọng liên quan đến bảo mật và tối ưu hóa máy chủ.

**Vị trí File Log** : Vị trí file Log nằm ở vị trí khác nhau với mỗi Distro Linux khác nhau

- Dối với Ubuntu và Debian: `/var/log/apache2/access.log`

![HTTP - HTTPs](./images/http_https_24.png)

- Đối với CentOS và RHEL: `/var/log/httpd/access_log`(Đối với CentOS7/8) và `/journalctl -u httpd`(Đối với CentOS9)

![HTTP - HTTPs](./images/http_https_25.png)

**Ví dụ về cấu trúc của 1 Access Log**:

![HTTP - HTTPs](./images/http_https_26.png)

- `192.168.60.1`: là địa chỉ IP máy khách
- `- -`: Trình giữ chỗ cho người dùng từ xa và đã được xác thực , nếu có. Mục nhập ví dụ không có thông tin cụ thể và các dấu gạch ngang là trình giữ chỗ.
- `[28/Oct/2025:03:23:20 +0000]`: Dấu thời gian yêu cầu có ngày, giờ và múi giờ chính xác.
- `"GET / HTTP/1.1"`: Phương thức yêu cầu ( GET), URL ( /) và phiên bản giao thức HTTP ( HTTP/1.1).
- `200`: Mã trạng thái HTTP mà máy chủ trả về. Mục nhập ví dụ hiển thị 200, cho biết yêu cầu đã thành công.
- `3460`: Kích thước phản hồi tính bằng byte . Giá trị ví dụ cho thấy máy chủ đã gửi 3460 byte trở lại máy khách. - `-`: Trường giới thiệu chứa trang web hướng khách hàng đến URL được yêu cầu. Giá trị ví dụ không khả dụng.
- `Mozilla/5.0 (Window NT 10.0; Win64; x64) AppleWebKit/537`: Chuỗi tác nhân người dùng được gửi từ trình duyệt web của máy khách . Chuỗi này chứa phiên bản trình duyệt và hệ điều hành ( Window).

### 2. ERROR LOG

**Nhật kí lỗi**:Nhật ký lỗi Apache chứa các báo cáo lỗi nghiêm trọng mà máy chủ gặp phải. Nhật ký ghi lại nhiều loại lỗi và chi tiết khác nhau, chẳng hạn như dữ liệu kết nối SSL/TLS , thay đổi trạng thái máy chủ, lỗi nội bộ hoặc lỗi máy khách, v.v.

**Công dụng chính**: là để khắc phục sự cố và theo dõi các vấn đề của máy chủ. Những nhật ký này là một tài sản quan trọng khi máy chủ gặp lỗi. Quản trị viên máy chủ sử dụng những nhật ký này để xác định và giải quyết sự cố nhanh chóng, đồng thời đảm bảo thời gian ngừng hoạt động tối thiểu.

**Ví trí File Log**: Vị trí file Log nằm ở vị trí khác nhau với mỗi Distro Linux khác nhau

- Đối với Ubuntu và Debian: `/var/log/apache2/error.log`

![HTTP - HTTPs](./images/http_https_27.png)

- Đối với CentOS và RHEL:`/var/log/httpd/error_log`(Đối với CentOS7/8) và `/journalctl -u httpd`(Đối với CentOS9)

![HTTP - HTTPs](./images/http_https_28.png)

**Ví dụ về cấu trúc của 1 Error Log**:

```ruby
[Fri Feb 09 15:35:24.252107 2024] [core:notice] [pid 6672:tid 139657266624384] AH00094: Command line: '/usr/sbin/apache2'
```

- `[Fri Feb 09 15:35:24.252107 2024]`: Dấu thời gian khi bản ghi được thêm vào tệp nhật ký lỗi. Định dạng dấu thời gian là [Weekday Month Day Hour:Minute:Second.Microsecond Year].
- `[core:notice]`: Thành phần tạo ra mục nhập nhật ký ( core) và mức độ nghiêm trọng ( notice).
- `[pid 6672:tid 139657266624384]`: ID tiến trình ( pid 6672) và ID luồng ( tid 139657266624384) liên quan đến mục nhập.
- `AH00094: Command line: '/usr/sbin/apache2'`: Thông báo lỗi (Thông báo ví dụ cho biết Apache đang hiển thị thông tin dòng lệnh)

### 3. CUSTOM LOG

## III. LOG COLLECTOR

**Trình thu thập nhật ký**(Log Collector) là các giải pháp được thiết kế để cải thiện việc quản lý nhật ký Apache. Chúng cung cấp khả năng lưu trữ dữ liệu nhật ký tập trung và các tính năng quản lý nhật ký nâng cao. Điều này bao gồm các công cụ quản lý nhật ký, cải tiến bảo mật, trực quan hóa nhật ký và cơ chế cảnh báo.

**Các ví dụ phổ biến về bộ sưu tập nhật ký là:**

- **ELKstack**: Ngăn xếp này kết hợp Elasticsearch, Logstash và Kibana để tạo ra một giải pháp mạnh mẽ và tập trung cho việc thu thập nhật ký, mỗi giải pháp có một nhiệm vụ cụ thể.

![HTTP - HTTPs](./images/http_https_29.png)

- **Splunk**: Là một công cụ phân tích và quản lý nhật ký nổi tiếng. Nền tảng này cung cấp khả năng tìm kiếm nâng cao, nhiều tùy chọn giám sát và bảng điều khiển tùy chỉnh.
- **Apache Flume**: Hệ thống thu thập, tổng hợp và di chuyển dữ liệu nhật ký đến một bộ lưu trữ tập trung hoặc để xử lý thêm. Apache Flume dễ dàng xử lý nhiều nguồn, lý tưởng cho các môi trường phân tán quy mô lớn.

![HTTP - HTTPs](./images/http_https_30.png)

## IV. CẤU HÌNH APACHE LOG

Việc cấu hình nhật ký Apache giúp thay đổi hành vi và định dạng mặc định. Việc tùy chỉnh cài đặt nhật ký Apache cho phép đáp ứng các yêu cầu cụ thể, chỉ thu thập dữ liệu cần thiết và tăng hiệu quả quản lý nhật ký.

Truy cập các tệp cấu hình Apache bằng trình soạn thảo văn bản để cấu hình nhật ký Apache. **Vị trí tệp** là:

- Đối với Ubuntu và Debian: `/etc/apache2/apache2.conf`
- Đối với CentOS và RHEL: `/etc/httpd/httpd.conf`
- Đới với Window: Tệp cấu hình trên Windows sẽ khác và rất có thể nằm trong thư mục cài đặt. Ví dụ: `C:\Program Files\Apache Software Foundation\Apache2.4\conf\ .`

### 1. Thay đổi vị trí nhật ký Apache mặc định

Để thay đổi vị trí nhật ký mặc định, hãy thực hiện như sau:

#### B1. Mở tệp cấu hình Apache bằng trình soạn thảo văn bản. Đối với Nano, hãy chạy

```ruby
sudo nano /etc/apache2/apache2.conf
```

Việc chỉnh sửa cấu hình mặc định yêu cầu quyền quản trị viên.

![HTTP - HTTPs](./images/http_https_31.png)

#### B2. Xác định vị ErrorLog vị trí chỉ thị và thay đổi đường dẫn. Dòng lệnh trông như sau

`ErrorLog [path]/error.log`

Vị trí ErrorLog `apache.conf`. Chỉnh sửa đường dẫn hoặc tên tệp theo mong muốn

![HTTP - HTTPs](./images/http_https_32.png)

#### B3. Để thay đổi vị trí nhật ký truy cập, hãy sử dụng `CustomLog` chỉ thị

 Chỉ thị này bao gồm ít nhất hai đối số: đường dẫn chứa tên tệp và chuỗi định dạng nhật ký. Ví dụ:

`CustomLog [path]/access.log combined`

![HTTP - HTTPs](./images/http_https_33.png)

Nếu không có, hãy thêm chỉ thị vào tệp cấu hình và chọn đường dẫn tệp, tên và chuỗi định dạng nhật ký.

#### B4. Lưu các thay đổi và đóng trình soạn thảo

#### B5. Khởi động lại dịch vụ Apache

```ruby
sudo systemctl restart apache2
```

Các bản ghi sẽ được tạo ngay lập tức ở vị trí mới.

### 2. Chỉ thị LogLevel

**Chỉ thị LogLevel** dùng để kiểm soát mức độ nghiêm trọng của các thông báo được ghi vào nhật ký lỗi (error log).
Nó bao gồm một tham số, là một trong các mức log được định nghĩa sẵn.

**Ví dụ:**

`LogLevel notice`

![HTTP - HTTPs](./images/http_https_34.png)

Các cấp độ có sẵn và mô tả ngắn gọn của chúng được nêu trong bảng dưới đây:

|  Mức độ |  Sự miêu tả |
|------------|----------------|
| **emerg** | Trường hợp khẩn cấp và lỗi nghiêm trọng. Hệ thống không hoạt động. |
| **alert** | Hệ thống cần phải có hành động ngay lập tức để ngăn ngừa thiệt hại hoặc gián đoạn thêm. |
| **crit** | Sự kiện quan trọng. Lỗi này cần được xử lý ngay lập tức nhưng không gây ra lỗi hệ thống. |
| **error** | Lỗi xảy ra trong quá trình hoạt động bình thường. Hệ thống không cần xử lý ngay lập tức. |
| **warn** | Những vấn đề tiềm ẩn cần được lưu ý. Nếu không được giải quyết, chúng có thể dẫn đến sai sót. |
| **notice** | Sự kiện bình thường. Chúng chứa thông tin bổ sung về những thay đổi trong hành vi của hệ thống. |
| **info** | Các thông báo cung cấp hoạt động và sự kiện ghi nhật ký máy chủ thường xuyên. |
| **debug** | Tin nhắn có thông tin gỡ lỗi chi tiết. |
| **trace[1-8]** | Theo dõi tin nhắn với mức độ chi tiết tăng dần. |

Khi chọn một mức log, hãy lưu ý rằng nó cũng ghi lại các sự kiện có mức độ nghiêm trọng cao hơn trong nhật ký.
Ví dụ, nếu chỉ thị `LogLevel` được đặt là `crit`, thì log cũng sẽ bao gồm các thông báo ở mức `alert` và `emerg`.

Mức được khuyến nghị cho hoạt động bình thường là ít nhất là `crit`, vì nó bao gồm tất cả các cảnh báo cần được xử lý ngay lập tức.

Các mức debug và trace[1-8] rất hữu ích khi gỡ lỗi (`troubleshooting`), vì chúng ghi lại thông tin chi tiết về hoạt động của hệ thống.

### 3. Chỉ thị LogFormat

**Chỉ thị LogFormat** cho phép tùy chỉnh định dạng của nhật ký truy cập (access log).
Một định dạng tùy chỉnh sẽ kiểm soát thông tin nào được ghi trong mỗi mục log và chỉ hiển thị những dữ liệu cần thiết trong file access log.

Ngoài ra, cũng có các định dạng được định nghĩa sẵn (predefined formats).

**Cú pháp** của chỉ thị **LogFormat** gồm hai đối số:

- Chuỗi định dạng (format string)

- Tên định dạng log (log format nickname)

Ví dụ:

`LogFormat "[format string]" [nickname]`

![HTTP - HTTPs](./images/http_https_35.png)

Chuỗi **format string** chứa **các trình giữ chỗ (placeholders)**, chúng sẽ được **thay thế bằng các giá trị thực tế** khi ghi vào **nhật ký truy cập (access log)**.  

Các **trình giữ chỗ tiêu chuẩn** được liệt kê trong bảng dưới đây:

| Trình giữ chỗ | Sự miêu tả |
|------------------|---------------|
| **%h** | Địa chỉ IP của máy khách (máy chủ từ xa). |
| **%l** | Tên đăng nhập từ xa (identd nếu được cung cấp). |
| **%u** | Người dùng từ xa (đối với các yêu cầu đã xác thực). |
| **%t** | Dấu thời gian. |
| **%>s** | Trạng thái yêu cầu sau khi Apache xử lý. |
| **%b** | Kích thước phản hồi tính bằng byte. |
| **%{Referrer}i** | Tiêu đề người giới thiệu đến (Referrer header). |
| **%{User-Agent}i** | Chuỗi thông tin trình duyệt / thiết bị của người dùng (User-Agent). |

Biệt danh là một cách nhanh chóng để tham chiếu định dạng trong chỉ thị `CustomLog`. Thêm các trường, chuỗi ký tự và ký tự điều khiển kiểu C để tùy chỉnh đầu ra hơn nữa.

### 4. Log Rotation (Vòng xoáy Log)

**Xoay vòng nhật ký** là quy trình lưu trữ và quản lý nhật ký. Theo thời gian, các tệp nhật ký sẽ lớn dần và chiếm dụng dung lượng ổ đĩa. Các tệp nhật ký lớn sẽ ảnh hưởng đến hiệu suất máy chủ và cần được lưu trữ và quản lý thường xuyên.

Apache cung cấp cơ chế luân chuyển nhật ký tích hợp sẵn. Một trong những cơ chế đó là `rotatelogs extension`. Đưa tiện ích vào chỉ thị `ErrorLog` và `CustomLog` và chỉ định định dạng tên tệp nhật ký.

Vị trí chương trình là cần thiết, nhưng có thể khác nhau giữa các hệ thống. Sử dụng lệnh sau để xem đường dẫn chương trình:

`which rotatelogs`

![HTTP - HTTPs](./images/http_https_36.png)

Lệnh này in đường dẫn chính xác trong bảng điều khiển và xuất hiện trong cú pháp để xoay vòng nhật ký:

`[directive] "|[rotatelogs path] [log path] [time interval or size]"`

Một ví dụ về việc luân chuyển nhật ký lỗi cho nhật ký lỗi trông như sau:

`ErrorLog "|/usr/bin/rotatelogs ${APACHE_LOG_DIR}/error.log.%Y-%m-%d_%H-%M-%S 10"`

![HTTP - HTTPs](./images/http_https_37.png)

Ở đây, `|/usr/bin/rotatelogs` là đường dẫn tới chương trình được dùng để xoay vòng log (piped program),
`${APACHE_LOG_DIR}/error.log.%Y-%m-%d_%H-%M-%S` là đường dẫn file log có thêm dấu thời gian (timestamp),
và `10` là khoảng thời gian (tính bằng giây) giữa mỗi lần xoay log.

### 5. Conditional Log - Ghi nhật kí có điều kiện

**Ghi nhật ký có điều kiện** cho phép lọc và chọn nhật ký dựa trên các thuộc tính yêu cầu cụ thể. Để bật và sử dụng ghi nhật ký có điều kiện, hãy làm như sau:

#### B1. Kích hoạt `mod_log_config` mô-đun trong tệp cấu hình Apache

```ruby
LoadModule log_config_module modules/mod_log_config.so
```

#### B2. Sử dụng `SetEnvIf`, lệnh này để thiết lập biến môi trường dựa trên một thuộc tính. Cú pháp chung là

```ruby
SetEnvIf [attribute] [regex] [variable]
```

Thuộc tính [attributte] là một trường tiêu đề yêu cầu HTTP, một thuộc tính yêu cầu hoặc một biến môi trường khác. Biểu thức chính quy [regex] khớp với thuộc tính[attribute], trong khi biến [vảiable] là tên với giá trị tùy chọn. Ví dụ:

`SetEnvIf Request_URI "^example$" dontlog`

Chỉ thị này sẽ so khớp với đường dẫn mẫu (pattern path) được cung cấp và gán giá trị không rỗng cho biến (dontlog) nếu khớp.

#### B3. Thêm biến [variable] vào CustomLog chỉ thị. Ví dụ

CustomLog ${APACHE_LOG_DIR}/access.log combined env=!dontlog

hỉ thị này ghi các mục log khi biến (dontlog) rỗng.

#### B4. Lưu và đóng tệp cấu hình

#### B5. Khởi động lại dịch vụ Apache để áp dụng các thay đổi

```ruby
sudo systemctl restart apache2
```

Làm việc với **Conditional Log** cho phép chỉ tập trung vào các nhật ký có liên quan, cải thiện hiệu quả ghi nhật ký và phân tích dữ liệu.

### 6. Change Log to JSON

#### a. JSON là gì?

**JSON** viết tắt của **JavaScript Object Notation** — là định dạng trao đổi dữ liệu nhẹ, dùng để lưu trữ và truyền dữ liệu giữa client và server.

#### b. Đặc điểm chính của JSON

|Đặc điểm                               |Mô tả                                            |
| ------------------------------------- |------------------------------------------------ |
| **Định dạng văn bản (text-based)**    | Dễ đọc, dễ ghi, có thể mở bằng bất kỳ trình soạn thảo nào.|
| **Cấu trúc dạng cặp “key : value”**   | Giống như object trong JavaScript.|
| **Độc lập ngôn ngữ**                  | Dù xuất phát từ JavaScript, JSON được hỗ trợ trong hầu hết mọi ngôn ngữ: Python, Java, PHP, Go, C++, v.v.|
| **Thường dùng trong API/Web Service** | Dữ liệu trả về từ API RESTful hầu hết ở dạng JSON.|

#### c. Cấu trúc JSON cơ bản

**Ví dụ:**

```ruby
{
  "name": "Tien",
  "age": 22,
  "skills": ["Linux", "DevOps", "Networking"],
  "active": true
}
```

**Giải thích:**

- "name" là key → "Tien" là value
- "skills" có giá trị là mảng (array)
- "active" có giá trị boolean (true/false)

#### d. Kiểu dữ liệu trong JSON

| Kiểu dữ liệu | Ví dụ              |
| ------------ | ------------------ |
| **String**   | `"Hello"`          |
| **Number**   | `123`              |
| **Boolean**  | `true`, `false`    |
| **Array**    | `["a", "b", "c"]`  |
| **Object**   | `{"key": "value"}` |
| **null**     | `null`             |

#### e. JSON được dùng ở đâu?

- Trao đổi dữ liệu giữa frontend và backend

  - Ví dụ: trình duyệt gửi request, server trả về JSON.

- Cấu hình hệ thống hoặc ứng dụng

  - Ví dụ: package.json, config.json

- Lưu trữ dữ liệu nhẹ

  - Dùng trong NoSQL DB như MongoDB, Firebase,...

#### f. Ví dụ thực tế (API)

**Khi mày gọi API:**

```ruby
nginx
GET https://api.github.com/users/octocat
```

**Server trả về JSON:**

```ruby
Json
{
  "login": "octocat",
  "id": 1,
  "public_repos": 8
}
```

#### g. Các bước chuyển Log(nhật kí) sang Json

**B1- Use Script**: Một ngôn ngữ script như **Python** hoặc **Bash** kết hợp biểu thức chính quy (regular expressions), xử lý chuỗi(string), và phân tích tệp theo từng dòng để chuyển đổi dữ liệu log thành các đối tượng JSON. Cách tiếp cận này mang lại toàn quyền kiểm soát quá trình chuyển đổi, nhưng đòi hỏi nhiều công sức hơn để xử lý các trường hợp đặc biệt.

**B2 - Use CLI**: Các công cụ dòng lệnh như `jq` hoặc `awk` không yêu cầu nhiều kiến thức lập trình để chuyển đổi văn bản log thành đối tượng JSON. Cách này phù hợp cho chuyển đổi nhanh hoặc các tác vụ thực hiện một lần.

**B3 - Use Framework and LogCollectionTool**: Những framework hoặc phần mềm phân tích log như `Apache Flume` hoặc `Logstash` là các giải pháp mạnh mẽ, có khả năng chuyển đổi dữ liệu tích hợp sẵn. Chúng cho phép nhận trực tiếp dữ liệu log từ Apache, phân tích và chuyển đổi thành định dạng JSON để sử dụng trong các hệ thống hoặc nền tảng lưu trữ khác.
