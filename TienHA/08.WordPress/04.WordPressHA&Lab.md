# WORDPRESSHA

Một trang web được triển khai thì có một thuật ngữ chúng ta cần quan tâm đó là **Traffic**(hay còn gọi là **lượt truy cập trang web**). Web càng lớn và càng phổ biến thì ta có lưu lượng **Traffic** càng nhiều. Vfa khi có lượng **Traffic** nhiều thì chúng ta sẽ cần phải quan tâm đến 1 khái niệm nữa đó là **WordpressHA** hay còn gọi là **WordpressHighAvailability**

Nói đến **Traffic** đối với team **SEO** và **Marketing** là 1 yếu tố mà họ cần để đánh giá chiến lược cho việc marketing trong tương lai. Ngoài ra, nói đến còn 1 số thuật ngữ chúng ta cần quan tâm đến

- **Pageviews (PV)**: số lần trang được tải (một người refresh nhiều lần vẫn tính nhiều)

- **Visits / Sessions**: số phiên truy cập (một người vào web rồi lướt trong một khoảng thời gian)

- **Users / Visitors**: số người dùng (thường là unique users)

- **Hits**: số request tới server (ít dùng để đánh giá vì 1 trang có thể tạo rất nhiều hit)

- **Traffic website**: cách nói chung cho tất cả mấy chỉ số trên

![WordPress](./images/WordPress_16.png)

## I. GIỚI THIỆU TỔNG QUAN VỀ WORDPRESS HA

### 1. High Availability(HA) là gì ?

- HA (High Availability) = Tính sẵn sàng cao

- Mục tiêu của **HA** với **WordPress**:

  - Website luôn online
  - Một Sever `die` thì có Sever khác `thay thế` (tính reserved)
  - Giảm **downtime** (thời gian web sập) về mức thấp nhất
  - Tránh downtime để ảnh hưởng tới doanh thu và trải nghiệm của khách hàng

### 2. WordPressHA là gì ?

- **WordPressHA** là **kiến trúc/mô hình** triển khai WordPress cùng với:
  - Nhiều WebSever WordPress (có web dự phòng khi web chính `die`)
  - Có **Load Balancer** ở phía trước Sever nhằm cân bằng user (khi web chính vượt `limit traffic` nó sẽ san ra web dự phòng)
  - **Database & Storage** dùng chung

    - **Storage**: là nơi lưu trữ SourceCode và Data(Data user `UPLOAD` lên) một cách đảm bảo lâu dài, nơi chia sẻ data giữa các sever, nơi Backup & Recovery dữ liệu
    - Ngoài ra có nhiều kiểu **Storage** như: **Local Storage** (Ổ cắm trực tiếp vào Sever như SSD,HDD,NVMe), **Net Storage**(`NAS` - `NetworkAttachStorage`, `SAN`-`StorageAreaNetwork`) hay **CloudStorage**(`Object Storage` - S3, GCS -> Nơi lưu ảnh, file, backup; `Block Storage`- EBS ->gắn như ổ cứng hay `File Storage` - EFS,NFS->Dùng như thư mục)

  - Không có SPOF(Single point of failure hay điểm mà nếu nó sập cả sever sập theo)

### Kiến trúc và Thành phần trong WordPress HA

![WordPress](./images/WordPress_17.png)

**Trong đó**:

#### Load balancer(Nginx/ HAProxy/ AWS ELB)

- **Khái niệm**: Là bộ chia tải (phân phối lưu lượng truy cập) và bảo vệ hệ thống khỏi sập

- **Tác dụng**:

  - Loại bỏ **SPOF**

  - Chia tải truy cập, **LB** chia đều request cho :

    - WP-Node-1
    - WP-Node-2
    - WP-Node-3  

    ->Mục đích: Không sever nào bị quá tải

  - Thực hiện **HealthCheck & FailOver**:

    - LB liên tục kiểm tra Nginx/Apache hoặc kiểm tra PHP-FPM (`FastCGI Process Manager` - Trình quản lí tiến trình PHP theo chuẩn Fast CGI)
    - Kiểm tra node lỗi -> Loại ngay khỏi pool
    - kiểm tra khi node hồi phục lại -> tự động nhận **Traffic** lại  

    ->Mục đich: User không thấy Downtime
  
  - Giữ **Session/Login** ổn định:

    - Trong **WordPress** có hỗ trợ **Login/Admin/WooCommerce cart** để giữ ổn định
    - Trong **LB** có hỗ trợ **StickySession**(Cơ chế LB nhằm đảm bảo trong phiên login 1 user chỉ gắn với 1 BackendSever duy nhất ) hoặc dùng cache **Redis** or **SessionDB**(dùng trong cơ chế LB - **SharedSessions**)

  - SSL Termination:

    - SSL xử lí tại **LoadBalancer**
    - BackEnd chỉ dùng HTTP nội bộ(Giảm tải WebSever, Dễ dàng quản lí chứng chỉ)

#### WebNode

- **Khái niệm**: một máy/**Instance**(**Instance** là một máy chủ ảo đang chạy, được tạo ra từ một **image** hay nó là 1 bản running copy của VM và nó được phân tài nguyên riêng)/Sever độc lập them gia vào hệ thống.

- Nó có thể là **VM**(EC2,OpenStack,VMware),**PhysicalSever**,**ContainerHost**

=> **Ngắn gọn hơn**: là máy chủ độc lập đảm nhiệm việc chạy các thành phần như **WP**, **DB** or **Storage**(tuỳ theo mô hình)

- **Tác dụng**:

  - Triển khai **WebNode** bằng cách chạy **Nginx/Apache**; **PHP-FPM**; **WordPressSourceCode** và **WebNode** sẽ có vai trò:  

    - Nhận Request từ LoadBalancer
    - Xử lí PHP
    - Trả HTML
  
  - Triển khai **DatabaseNode** bằng cách chạy **MySQL** or **MariaDB** và **DBNode** sẽ có vai trò :

    - Lưu dữ liệu **post**, **user**, **comment**, **option**

    ->Mục đích: Lưu data có mối quan hệ với nhau(Data của User). Và chạy **DBNode** theo mô hình **Primary(DB chính)** - **Replica(DB phụ)** nhằm đảm bảo tính **HA** hay dự phòng cho dữ liệu

  - Triển khai **StorageNode**(tuỳ mô hình) bằng cách chạy **NFS**/**GlusterFS**/**CephFS** hay ObjectStorage(MinIO) và nó sẽ có vai trò:

    - Lưu file upload của User
    - Dùng chung cho WebNode

#### Shared Storage và Object Storage

- **Khái niệm**

  - **Shared Storage** là kho lưu trữ dùng chung cho phép nhiều máy chủ truy cập đồng thời vào cùng một tập dữ liệu nhằm đảm bảo tính nhất quán trong kiến trúc **High Availability**.
  - **Object Storage** là kho lưu trữ dữ liệu dưới dạng **Object**, cho phép truy cập thông qua API, phù hợp cho việc lưu trữ dữ liệu phi cấu trúc với khả năng mở rộng lớn.

- **Đặc điểm**:

  - Đối với **Shared Storage**:

    - Dữ liệu dùng chung với nhiều máy.
    - Thường dùng dưới dạng file system(nhiều Sever dùng chung ổ đĩa logic hay còn gọi `mount disc`)
    - Giúp cho các WebNode sử dụng chung thư mục `wp-content` thông qua mạng

    ```scss
    Web Node 1  ─┐
             ├──(Network)──► NFS Server (/data/wp-content)
    Web Node 2  ─┘
    ```

  - Đối với **Object Storage**:

    - Mỗi **Object** gồm: Data, MetaData, Object ID -> Truy cập qua **API(HTTP/REST)**, không mount như ổ đĩa
    